\chapter{Численные эксперименты}\label{chap2}

В настоящей главе проведем ряд численных экспериментов по простроению МРС-регуляторов в задаче стабилизации линейной системы с ограничениями согласно явной схеме с применением МРТ и по построению синтеза оптимальных обратных связей в линейной задаче оптимального управления.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Применение параметрического программирования в MPC}\label{2sec:parametric-programming-mpc}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Рассмотрим дискретную линейную систему управления:
\begin{equation}\label{sys1}
     x (t + 1) = \begin{bmatrix}
            1 & 1\\
            0 & 1
        \end{bmatrix}x(t) + \begin{bmatrix}
            1\\
            0.5
        \end{bmatrix}u(t),
\end{equation}
c ограничениями $-5 \le x(t) \le 5$ и $-1 \le u(t) \le 1$, $t= 0,1, \ldots$.

Для динамической системы (\ref{sys1}), положение равновесия которой, очевидно, находится в начале координат, рассмотрим задачу стабилизации. Для решения задачи стабилизации применим явную схему МРС, в которой прогнозирующая задача --- линейно-квадратичная с горизонтом прогнозирования $N = 7$, отклонение траектории от устойчивой оценивается квадратами  евклидовых норм:
$$
    \sum_{k=0}^{N-1} \left[||x(k|\ t)||^2 + ||u(k|\ t)||^2\right].
$$

Для данного примера задача многопараметрического программирования была решена с использованием панели инструментов MPT.

Матрицы для задачи будут следующие:
\begin{verbatim}
A = [ 1, 1; 0,  1];
B = [ 1; 0.5];
\end{verbatim}

Задаем линейную модель с дискретным временем:

\begin{verbatim}
sys = ss(A,B,[],[],1);
model = LTISystem(sys);
\end{verbatim}

Зададим ограничения на управления и состояния:

\begin{verbatim}
model.x.min = [-5; -5];
model.x.max = [5; 5];
model.y.min = [-10; -10];
model.y.max = [10; 10];
model.u.min = -1;
model.u.max = 1;
\end{verbatim}

\noindent параметры критерия качества
\begin{verbatim}
R = 1;
model.u.penalty = QuadFunction(R);
model.x.penalty = QuadFunction(eye(2));
\end{verbatim}

\noindent и терминальные значения:
\begin{verbatim}
P = model.LQRPenalty;
Tset = model.LQRSet;
\end{verbatim}

Наконец, формулируем задачу MPC:
\begin{verbatim}
ctrl = MPCController(model,7);
\end{verbatim}

Результаты моделирования замкнутой системы управляющее показаны на рис. \ref{fig:4-1-res}. На рис. \ref{fig:4-1-res} а) представлена реализация обратной связи (управляющее воздействие, поданное на объект в конкретном процессе) для  начального состояния $x_0 = (3, 1)$. На рис. \ref{fig:4-1-res2} изображено разбиение допустимой области на критические области и траектории замкнутой системы для нескольких начальных значений. Из рисунка видно, что задача стабилизации успешно решена.

% \begin{figure}[h!]
%     \centering
%     \includegraphics[width=0.6\textwidth]{u-mpc.eps}
%     \includegraphics[width=0.6\textwidth]{controller-partition.eps}
%     \caption{Результаты}
%     \label{4-1-res}
% \end{figure}

\begin{figure}[h!]
    \centering
    \begin{subfigure}[b]{0.4\linewidth}
      \includegraphics[width=\linewidth]{pctr-u.eps}
      \caption{Управляющее воздействие}
    \end{subfigure}
    \begin{subfigure}[b]{0.4\linewidth}
      \includegraphics[width=\linewidth]{pctr-x.eps}
      \caption{Траектории X}
    \end{subfigure}
    \caption{Результаты реализации для $x = (3, 1)$}
    \label{fig:4-1-res}
  \end{figure}

  \begin{figure}[h!]
    \centering
    \includegraphics[width=0.7\linewidth]{pctr-expl.eps}
    \caption{Критические области и траектории замкнутой системы  для нескольких начальных значений}
    \label{fig:4-1-res2}
  \end{figure}

\newpage

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Применение параметрического программирования в задаче синтеза оптимальной линейной системы}\label{2sec:parametric-programming-mpc}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

В качестве примера синтеза рассмотрим задачу оптимизации колебательной системы второго порядка, критерием качества в которой является минимизация полного импульса управляющего воздействия:
$$
    J(u) = \int_0^{t_f}|u(t)|dt \to \min,
    $$
$$
        \dot{x_1} = x_2,\\
        \dot{x_2} = -x_1 + u,
$$

с ограничениями $-10 \le x \le 10$ и $-1 \le u(t) \le 1,\ t = 0,1, \cdots$. 

Параметрам присвоим значения: $t_0 = 0, t_f = 10$, число моментов квантования положим равным $N=20$, тогда период квантования $h=0.5$.

Для использования МРТ, необходимо сформулировать соответствующую задачу для дискретизированной системы. Для этого воспользуемся следующими функциями Matlab

\begin{verbatim}
sys = ss(A, B, [], []);
sysd = c2d(sys,tf/N,'zoh');
\end{verbatim}

В результате будут получены следующие матрицы

$$
    A_d = \begin{bmatrix}
        0.8776 & 0.4794\\
        -0.4794 &  0.8776\\
    \end{bmatrix}
    B_d = \begin{bmatrix}
        0.1224 \\
        0.4794 \\
    \end{bmatrix}
    $$
описывающие дискретную систему $x(t+1)  = A_d x(t) + B_d u(t)$, $x(0)=0$, $t=0, 1, 2, \ldots$.


В МРТ  нужно задать все параметры задачи, чтобы передать их в $mpt constructMatrices$, которая  представляет собой функцию, на вход которой приходят параметры $probStruc$t и $sysStruct$.
Структура системы $sysStruct$ будет состоять из матриц $A$, $B$, $C=(0, 0)$, $D=0$, ограничений на $x$ ($x_min$ и $x_max$) и ограничений на $u$ ($u_min$ и $u_max$). Структура задачи $probStruct$ в свою очередь будет состоять из выбранной нормы, числа $N$, а также $Q$, $P_N$, $R$ и тд. В рассматриваемой задаче вид критерия таков, что $Q = 0$, $P_N = 0$, $R=1$, норма равномерная.


Чтобы отобразить полную структуру задачи в Matlab поступим так, как показано ниже:

\begin{verbatim}
sysStruct.A= Ad;
sysStruct.B= Bd;
sysStruct.C= [0 0];
sysStruct.D= 0;
\end{verbatim}

\begin{verbatim}
sysStruct.xmin = [-10; -10];
sysStruct.xmax = [10; 10];
\end{verbatim}

\begin{verbatim}
sysStruct.umin = -1;
sysStruct.umax = 1;
\end{verbatim}

\begin{verbatim}
nx = size(A, 2);
probStruct.norm=inf;
probStruct.Q=[0 0; 0 0];
probStruct.P_N=[0 0; 0 0];
probStruct.R=1;
probStruct.N=N;
probStruct.subopt_lev=0;
H = [eye(nx); -eye(nx)];
K = eps*ones(nx*2,1);
probStruct.Tconstraint=2;
probStruct.Tset = polytope(H, K);
\end{verbatim}

После выполнения такого кода  будем иметь все параметры рассматриваемой задачи, сгенерированные в структуру, которую можно решить, используя известные процедуры. 

Далее нужно на основании $mpt constructMatrices$ посмотреть класс $Opt$, который инкапсулирует информацию и решения для задач LP/QP/pLP/pQP/LCP/pLCP.
Для конкретного момента времени строится $u$ на основании заданного $x_\tau$ и подается на систему. Процедура выполняется в каждый момент  из $T_h$.

Будем реализовывать описанную выше операцию в цикле на каждом шаге и на половине пути добавим возмущение $w$.
\begin{verbatim}
for tau = 0:NN-1
    probStruct.N=N;
    Matrices = mpt_constructMatrices(sysStruct,probStruct);
    plp = Opt(Matrices);
    solution = plp.solve();
    u = solution.xopt.feval(xtau, 'primal');
    if N > NN/2
        xtau = Ad * xtau + Bd * u(1) + w;
    else
        xtau = Ad * xtau + Bd * u(1);
    end

    figure;
    solution.xopt.fplot('obj');
    xlabel('x0');
    ylabel('J(x0)');
    N = N-1;
    X = [X xtau];
    U = [U u(1)];
end
\end{verbatim}
\bigskip


Из рисунка \ref{4-img-1} видно, что количество критических областей уменьшается с увеличением $\tau$. На рисуенке \ref{4-img1-1} а) представлены траектории и управляющее воздействие для $x_0 = (0, 5)$. На рисунке  \ref{4-img1-1} b) можем видеть фазовые траектории для $x_0 = (0, 5)$.

\begin{figure}[h!]
    \centering
    \begin{subfigure}[b]{0.48\linewidth}
    \includegraphics[width=1\textwidth]{figure1.eps}
      \caption{N = 20, $\tau = 0$}
    \end{subfigure}
    \begin{subfigure}[b]{0.48\linewidth}
        \includegraphics[width=1\textwidth]{figure5.eps}
      \caption{N = 15, $\tau = 2.5$}
    \end{subfigure}
    \begin{subfigure}[b]{0.48\linewidth}
    \includegraphics[width=1\textwidth]{figure10.eps}
      \caption{N = 10, $\tau = 5$}
    \end{subfigure}
    \begin{subfigure}[b]{0.48\linewidth}
        \includegraphics[width=1\textwidth]{figure20.eps}
      \caption{N = 1, $\tau = 9.5$}
    \end{subfigure}
    \caption{Критические области при различных значениях $\tau$ и количеством оставшихся точек равных $N$}
    \label{4-img-1}
\end{figure}

\begin{figure}[h!]
    \centering
    \begin{subfigure}[b]{0.48\linewidth}
        \includegraphics[width=1\textwidth]{graphics-42.eps}
      \caption{Траектории и управление для $x_0 = (0, 5)$}
    \end{subfigure}
    \begin{subfigure}[b]{0.48\linewidth}
        \includegraphics[width=1\textwidth]{x1x2.eps}
      \caption{Фазовые траектории для $x_0 = (0, 5)$}
    \end{subfigure}
    \caption{Траектории, управление и фазовые траектории для $x_0 = (0, 5)$}
    \label{4-img1-1}
\end{figure}
% \clearpage
\newpage

Далее перейдем к решению задачи, которая была рассмотрена выше без изпользования пакета MPT, затем сравним полученные результаты.

Задача будет решаться стандартной процедурой $linprog$ пакета Matlab:
\begin{verbatim}
    u0 = 
      linprog([ch', ch'],[],[],[dh,-dh],
        g0,zeros(2*N,1),L*ones(2*N,1)),
\end{verbatim}
где $c_h$ в данной задаче будет вектор размерности $N$, состоящий из $h$, а $g_0$ будет вычисляются по формуле:
$$
    g_0 = g - HF(t_f, t_0)x_0.
$$
Зададим это в программе с помощью следующих команд: 
\begin{verbatim}
    ch = h*ones(1,N);
    g0 = g-H*F(tf-t0)*x0.
\end{verbatim}
$g_0$ будет вектором:
$$
    g_0 = \begin{bmatrix}
        -2.7201\\
        4.1954
    \end{bmatrix}.
$$
Значения $d_h$, в свою очередь, будет заполняться с помощью цикла, высчитывая интеграл $\int_{t}^{t+h} HF(t_f - t)b$ на каждом шаге:
\begin{verbatim}
    for i = 1:N
        dh(:,i) = integral(d,t0+h*(i-1),t0+h*i,'ArrayValued',true);
    end
\end{verbatim}
где $d$ --- подинтегральная функция:
\begin{verbatim}
    d = @(t)H*F(tf-t)*b;
\end{verbatim}.
Матрица $F$ задается функцией:
\begin{verbatim}
    F = @(t)expm(A*t);
\end{verbatim}
и состоит из следующих значений:
$$
    F = \begin{bmatrix}
        0.8776 & 0.4794\\
        -0.4794 & 0.8776
    \end{bmatrix}.
$$
Наконец, $x$ будем считать на каждом шаге, добавляя возмущение $w = 0.05$, когда $i > N/2$:
\begin{verbatim}
    x(:,i+1) = F(h)*x2(:,i) +
        integral(@(t)u2(i)*F(t0+(i+1)*h-t)*b + w,
        t0 + i*h, t0+(i+1)*h,'ArrayValued',true);
\end{verbatim}

График оптимальной программы $u^0(t)$ и фазовый портрет оптимальной траектории $x^0(t)$ на плоскости $x_1, x_2$ показаны на рисунке \ref{picture-primer}
\begin{figure}[h!]
    \centering
    \begin{subfigure}[b]{0.4\linewidth}
        \includegraphics[width=\linewidth]{primer2-u.eps}
        \caption{Оптимальная программа}
      \end{subfigure}
    \begin{subfigure}[b]{0.4\linewidth}
      \includegraphics[width=\linewidth]{picture2-x.eps}
      \caption{Фазовый портрет оптимальной траектории}
    \end{subfigure}
    \caption{Результаты}
    \label{picture-primer}
  \end{figure}   
\newpage

Таким образом можем заметить, что полученные результаты совпадают с методом, который использует в своей основе возможности MPT для решения подобного рода задач, описанный выше. Также стоит заметить, что при решении задач в MPT вся работа проводится до начала процесса, а онлайн требуется только нахождение области. При решении задачи вторым способом, необходимо решать задачу оптимального управления онлайн.