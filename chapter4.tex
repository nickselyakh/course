\chapter{Численные эксперименты}\label{chap2}

В настоящей главе проведем ряд численных экспериментов по простроению МРС-регуляторов в задаче стабилизации линейной системы с ограничениями согласно явной схеме с применением МРТ и по построению синтеза оптимальных обратных связей в линейной задаче оптимального управления.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Применение параметрического программирования в MPC}\label{2sec:parametric-programming-mpc}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Рассмотрим дискретную линейную систему управления:
\begin{equation}\label{sys1}
     x (t + 1) = \begin{bmatrix}
            1 & 1\\
            0 & 1
        \end{bmatrix}x(t) + \begin{bmatrix}
            1\\
            0.5
        \end{bmatrix}u(t),
\end{equation}
c ограничениями $-5 \le x(t) \le 5$ и $-1 \le u(t) \le 1$, $t= 0,1, \ldots$.

Для динамической системы (\ref{sys1}), положение равновесия которой, очевидно, находится в начале координат, рассмотрим задачу стабилизации. Для решения задачи стабилизации применим явную схему МРС, в которой прогнозирующая задача --- линейно-квадратичная с горизонтом прогнозирования $N = 7$, отклонение траектории от устойчивой оценивается квадратами  евклидовых норм:
$$
    \sum_{k=0}^{N-1} \left[||x(k|\ t)||^2 + ||u(k|\ t)||^2\right].
$$

Для данного примера задача многопараметрического программирования была решена с использованием панели инструментов MPT.

Матрицы для задачи будут следующие:
\begin{verbatim}
A = [ 1, 1; 0,  1];
B = [ 1; 0.5];
\end{verbatim}

Задаем линейную модель с дискретным временем:

\begin{verbatim}
sys = ss(A,B,[],[],1);
model = LTISystem(sys);
\end{verbatim}

Зададим ограничения на управления и состояния:

\begin{verbatim}
model.x.min = [-5; -5];
model.x.max = [5; 5];
model.y.min = [-10; -10];
model.y.max = [10; 10];
model.u.min = -1;
model.u.max = 1;
\end{verbatim}

\noindent параметры критерия качества
\begin{verbatim}
R = 1;
model.u.penalty = QuadFunction(R);
model.x.penalty = QuadFunction(eye(2));
\end{verbatim}

\noindent и терминальные значения:
\begin{verbatim}
P = model.LQRPenalty;
Tset = model.LQRSet;
\end{verbatim}

Наконец, формулируем задачу MPC:
\begin{verbatim}
ctrl = MPCController(model,7);
\end{verbatim}

Результаты моделирования замкнутой системы управляющее показаны на рис. \ref{fig:4-1-res}. На рис. \ref{fig:4-1-res} а) представлена реализация обратной связи (управляющее воздействие, поданное на объект в конкретном процессе) для  начального состояния $x_0 = (3, 1)$. На рис. \ref{fig:4-1-res} b) изображено разбиение допустимой области на критические области и траектории замкнутой системы для нескольких начальных значений. Из рисунка видно, что задача стабилизации успешно решена.

% \begin{figure}[h!]
%     \centering
%     \includegraphics[width=0.6\textwidth]{u-mpc.eps}
%     \includegraphics[width=0.6\textwidth]{controller-partition.eps}
%     \caption{Результаты}
%     \label{4-1-res}
% \end{figure}

\begin{figure}[h!]
    \centering
    \begin{subfigure}[b]{0.4\linewidth}
      \includegraphics[width=\linewidth]{pctr-u.eps}
      \caption{Управляющее воздействие}
    \end{subfigure}
    \begin{subfigure}[b]{0.4\linewidth}
      \includegraphics[width=\linewidth]{pctr-x.eps}
      \caption{Траектории X}
    \end{subfigure}
    \begin{subfigure}[b]{0.4\linewidth}
      \includegraphics[width=\linewidth]{pctr-expl.eps}
      \caption{Критические области и траектории замкнутой системы  для разных начальных значений}
    \end{subfigure}
    \caption{Результаты}
    \label{fig:4-1-res}
  \end{figure}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Применение параметрического программирования в задаче синтеза оптимальной линейной системы}\label{2sec:parametric-programming-mpc}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

В качестве примера рассмотрим задачу оптимизации колебательной системы второго порядка, критерием качества в которой является минимизация полного импульса управляющего воздействия:
$$
    J(u) = \int_0^{t_f}|u(t)|dt \to \min,
    $$
$$
        \dot{x_1} = x_2,\\
        \dot{x_2} = -x_1 + u,
$$

с ограничениями $-10 \le x \le 10$ и $-1 \le u(t) \le 1,\ t = 0,1, \cdots$. 

Параметрам присвоим значения: $t_0 = 0, t_f = 10$, число моментов квантования положим равным $N=20$, тогда период квантования $h=0.5$.

Для использования МРТ, необходимо сформулировать соответствующую задачу для дискретизированной системы. Для этого воспользуемся следующими функциями Matlab

\begin{verbatim}
sys = ss(A, B, [], []);
sysd = c2d(sys,tf/N,'zoh');
\end{verbatim}

В результате будут получены следующие матрицы

$$
    A_d = \begin{bmatrix}
        0.8776 & 0.4794\\
        -0.4794 &  0.8776\\
    \end{bmatrix}
    B_d = \begin{bmatrix}
        0.1224 \\
        0.4794 \\
    \end{bmatrix}
    $$
описывающие дискретную систему $x(t+1)  = A_d x(t) + B_d u(t)$, $x(0)=0$, $t=0, 1, 2, \ldots$.


В МРТ  нужно задать все параметры задачи, чтобы передать их в $mpt constructMatrices$, которая  представляет собой функцию, на вход которой приходят параметры $probStruc$t и $sysStruct$.
Структура системы $sysStruct$ будет состоять из матриц $A$, $B$, $C=(0, 0)$, $D=0$, ограничений на $x$ ($x_min$ и $x_max$) и ограничений на $u$ ($u_min$ и $u_max$). Структура задачи $probStruct$ в свою очередь будет состоять из выбранной нормы, числа $N$, а также $Q$, $P_N$, $R$ и тд. В рассматриваемой задаче вид критерия таков, что $Q = 0$, $P_N = 0$, $R=1$, норма равномерная.


Чтобы отобразить полную структуру задачи в Matlab поступим так, как показано ниже:

\begin{verbatim}
sysStruct.A= Ad;
sysStruct.B= Bd;
sysStruct.C= [0 0];
sysStruct.D= 0;
\end{verbatim}

\begin{verbatim}
sysStruct.xmin = [-10; -10];
sysStruct.xmax = [10; 10];
\end{verbatim}

\begin{verbatim}
sysStruct.umin = -1;
sysStruct.umax = 1;
\end{verbatim}

\begin{verbatim}
nx = size(A, 2);
probStruct.norm=inf;
probStruct.Q=[0 0; 0 0];
probStruct.P_N=[0 0; 0 0];
probStruct.R=1;
probStruct.N=N;
probStruct.subopt_lev=0;
H = [eye(nx); -eye(nx)];
K = eps*ones(nx*2,1);
probStruct.Tconstraint=2;
probStruct.Tset = polytope(H, K);
\end{verbatim}

После выполнения такого кода  будем иметь все параметры рассматриваемой задачи, сгенерированные в структуру, которую можно решить, используя известные процедуры. 

Далее нужно на основании $mpt constructMatrices$ посмотреть класс $Opt$, который инкапсулирует информацию и решения для задач LP/QP/pLP/pQP/LCP/pLCP.
Для конкретного момента времени строится $u$ на основании заданного $x_\tau$ и подается на систему. Процедура выполняется в каждый момент  из $T_h$.

Будем реализовывать описанную выше операцию в цикле на каждом шаге и на половине пути добавим возмущение $w$.
\begin{verbatim}
for tau = 0:NN-1
    probStruct.N=N;
    Matrices = mpt_constructMatrices(sysStruct,probStruct);
    plp = Opt(Matrices);
    solution = plp.solve();
    u = solution.xopt.feval(xtau, 'primal');
    if N > NN/2
        xtau = Ad * xtau + Bd * u(1) + w;
    else
        xtau = Ad * xtau + Bd * u(1);
    end

    figure;
    solution.xopt.fplot('obj');
    xlabel('x0');
    ylabel('J(x0)');
    N = N-1;
    X = [X xtau];
    U = [U u(1)];
end
\end{verbatim}
\bigskip


На рис. \ref{4-img-1}) приведены результаты работы МРТ --- критические области для моментов $\tau = 0$, $\tau = 2.5$, $\tau = 5$, $\tau = 9.5$.

\begin{figure}[h!]
    \centering
    \begin{subfigure}[b]{0.48\linewidth}
    \includegraphics[width=1\textwidth]{figure1.eps}
      \caption{N = 20, $\tau = 0$}
    \end{subfigure}
    \begin{subfigure}[b]{0.48\linewidth}
        \includegraphics[width=1\textwidth]{figure5.eps}
      \caption{N = 15, $\tau = 2.5$}
    \end{subfigure}
    \begin{subfigure}[b]{0.48\linewidth}
    \includegraphics[width=1\textwidth]{figure10.eps}
      \caption{N = 10, $\tau = 5$}
    \end{subfigure}
    \begin{subfigure}[b]{0.48\linewidth}
        \includegraphics[width=1\textwidth]{figure20.eps}
      \caption{N = 1, $\tau = 9.5$}
    \end{subfigure}
    \begin{subfigure}[b]{0.48\linewidth}
        \includegraphics[width=1\textwidth]{graphics-42.eps}
      \caption{X и U}
    \end{subfigure}
    \begin{subfigure}[b]{0.48\linewidth}
        \includegraphics[width=1\textwidth]{x1x2.eps}
      \caption{$X_1, \ X_2$}
    \end{subfigure}
    \caption{Результаты}
    \label{4-img-1}
\end{figure}
\clearpage


\bigskip
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

Тут постановку не надо, надо решить ту же задачу для сравнения. Или эту решить с помощью МРТ, а то я не понимаю, к чему такой пример.


!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
\bigskip

\bigskip



Ранее была рассмотрена теоретическая база по построению классической оптимальной обратной связи. В данной главе проилюстриуем, как параметрическое программирование применяется в задачах синтеза оптимальной линейной системы.

Рассмотрим следующую задачу:
\begin{equation}
    \begin{aligned}
    & x_1(t_f) \to \min,\\
    & x_2(t_f) = 0,\\
\end{aligned}
\end{equation}
на траекториях системы второго порядка
$$
    \begin{cases}
        \dot{x_1} = x_2,\\
        \dot{x_2} = -x_1 + u,
    \end{cases}
    x_1(t_0) = x_{10},\
    x_2(t_0) = x_{20},
$$
с ограничениями $-L \le u \le L, \ t \in T = [t_0,\ t_f]$
\\
Матрица A имеет вид:
$$
A = \begin{bmatrix}
    0 & 1\\
    -1 & 0
\end{bmatrix}
$$
Вектром $b$ выглядит следующим образом:
$$
b = \begin{bmatrix}
    0 \\
    1
\end{bmatrix}
$$
Матрица $H$:
$$
H = \begin{bmatrix}
    0 \\
    1
\end{bmatrix}
$$

Параметрам задачи присвоим значения: $t_0 = 0,\ t_f = 10$.
Будем использовать дискретные управляющие воздействия с шагом $h = \frac{t_f - t_0}{100}$.
Остальные параметры в программе зададим таким образом:

$c_h, d_h$ на каждом шаге в matlab вычисляется процедурой integral в Matlab, которое высчитывается в цикле для каждого шага:

\begin{verbatim}
for i = 1:N
    ch(i) = integral(C,t0+h*(i-1),t0+h*i,'ArrayValued',true);
    dh(i) = integral(d,t0+h*(i-1),t0+h*i,'ArrayValued',true);
end
\end{verbatim}

$u_0$, в свою очередь, вычисляется с помощью процедуры linprog:
\begin{verbatim}
u0 = linprog(-ch',[],[],dh,g0,-L*ones(N,1),L*ones(N,1))
\end{verbatim}

Далее рассчитаем $x$:
\begin{verbatim}
x = zeros(2,N+1);
x(:,1) = x0;
for i = 1:N
    x(:,i+1) = F(h)*x(:,i)+integral(@(t)u0(i)*F(t0+(i+1)*h-t)*b,t0+i*h,t0+(i+1)*h,'ArrayValued',true);
end
x1 = zeros(2,N+1);
x1(:,1) = x0;
for i = 1:N
    x1(:,i+1) = F(h)*x1(:,i)+integral(@(t)u0(i)*F(t0+(i+1)*h-t)*b+w(t),t0+i*h,t0+(i+1)*h,'ArrayValued',true);
end
\end{verbatim}


Затем на определенном промежутке времени добавим возмущение $w$ и придет к ответу с помощью известных уже нам процедур:
\begin{verbatim}
    for j = 1:N
        j
        if j>90
            w = @(t)0*cos(3*t);
        end
        tau = t0 + (j-1)*h;
        g0 = g-H*F(tf-tau)*x2(:,j);
        u1 = linprog(-ch(j:N),[],[],dh(j:N),g0,-L*ones(N-j+1,1),L*ones(N-j+1,1))
        u2(j) = u1(1);

        x2(:,j+1) = F(h)*x2(:,j)+integral(@(t)u2(j)*F(t0+(j+1)*h-t)*b+w(t),t0+j*h,t0+(j+1)*h,'ArrayValued',true);
        x(:,j+1)
        x2(:,j+1)
    end
\end{verbatim}

Результаты для начального значения $x_0 = [1; -1]$ показаны на рисунке \ref{picture-primer}


\begin{figure}[h!]
    \centering
    \begin{subfigure}[b]{0.4\linewidth}
      \includegraphics[width=\linewidth]{primer2-1.eps}
      \caption{X}
    \end{subfigure}
    \begin{subfigure}[b]{0.4\linewidth}
      \includegraphics[width=\linewidth]{primer2-3.eps}
      \caption{U}
    \end{subfigure}
    \caption{Результаты}
    \label{picture-primer}
  \end{figure} 