\chapter{Применение параметрического программирования в задачах синтеза и MPC}\label{chap2}

Объектом исследования дипломной работы являются задачи оптимального управления и задачи стабилизации, для которых требуется построить управления типа обратной связи. Инструментом построения обратной связи является многопараметрическое программирование. В настоящей главе покажем, как воспользоваться этим инструментом для построения стабилизирующей обратной связи или оптимальнйо обратной связи в явном виде.

Фактически, мы сформулируем задачи оптимального управления с конечным горизонтом в виде задач математического программирования, в которых управление является вектором оптимизации. Текущее состояние динамической системы входит в функцию стоимости и ограничения в качестве параметра, который влияет на решение задачи математического программирования.

Изучив структуру решения при изменении этого параметра, покажем, что решение задач оптимального управления может быть выражено в виде кусочно-афинной обратной связи. Кроме того, эта обратная связь будет непрерывна, а оптимальное значение задачи --- выпукло и непрерывно.

\section{Явный MPC}
Управление по прогнозирующей модели с использованием многопараметрического программирования получило название явного МРС, поскольку обратная связь строится в явном виде. Явный МРС --- очень популярный подход, который реализует идею, в которой вычисления переносятся со второго шага базового алгоритма MPC на подготовительный (еще до начала вычислений). Явные схемы на текущий момент времени могут быть использованы только для линейных динамических систем и линейных или квадратичных критериев качества.

В основе явных схем лежат следующие наблюдения: линейные или линейно-квадратичные задачи оптимального управления при численном решении сводятся к задачам линейного или квадратичного программирования, которые зависят от состояния $x = x(t)$, которое, в свою очередь, принимается как параметр. В итоге получаем задачу параметрического программирования, для которой к настоящему моменту были развиты специальные методы решения. Они позволяют нам получить явный закон управления $u(x)$.

Развитие подхода на нелинейные системы является не тривиальным, однако и в линейных случаях есть проблемы, касающиеся эффективности вычислений даже для задач средней размерности.

Ниже продемонстрируем основную идею явного MPC.

Рассматривается задача стабилизации линейной дискретной стационарной системы, для которой формулируется прогнозирующая задачи оптимального управления следующего вида:
\begin{equation} \label{yav-1}
    J(x) = \min_{u(\cdot | t)} \sum_{t}^{t+N-1} L(x(k(t), u(k(t))) + F(x(t+N)t)),
\end{equation}
при условиях
$$
x(k+1 |\ t) = Ax(k\ |\ t) + Bu(k\ |\ t), \\
$$
$$
x(t\ |\ t) = x(t),
$$
$$
C_{x}x(k\ |\ t) \le d_x, \ t \le k \le t+N-1,
$$
$$
C_{u}u(k\ |\ t) \le d_u, \ C_{x}x(t+N\ |\ t) = d_f,
$$
$$
C_f x(t + N |\ t) \le d_f,
$$
со следующей квадратичной функцией стоимости конкретного этапа и терминальной стоимостью:
$$
\begin{aligned}
        & L(x, u) = x^TQx + u^TRu, \\
        & F(x) = x^TQx,\ Q,R > 0, \\
\end{aligned}
$$
где $C_x, C_u, C_f, d_x, d_u, d_f$ задают ограничения на траекторию, управления и терминальное состояние.

Перепишем (\ref{yav-1}) в виде задачи квадратичного программирования:
\begin{equation*} \label{yav-2}
    X := [x^T(t + 1 |\ t),\ \dots,\ x^T(t + N|\ t)]^T,
\end{equation*}
\begin{equation*} \label{yav-3}
    U := [u^T(t |\ t),\ \dots,\ u^T(t + N-1|\ t)]^T,
\end{equation*}
\begin{equation} \label{yav-4}
    J(x(t),\ U) = x^T(t)Qx(t)+X^T\tilde{Q}X + U^T\tilde{R}U,
\end{equation}
где $\tilde{Q} = diag(Q, \dots, Q, P) \in \mathbb{R}^{n(N+1) \times n(N+1)},\ \tilde{R} = diag(R,\dots,R) \in \mathbb{R}^{mN \times mN}$.

Далее выражаем состояние системы в момент $t + k$ через $x(t)$ и $u$:
$$
    x(t+k \ |\ t) = A^kx(t) + \sum_{j=0}^{k-1}A^jBu(t+k-j-1 \ |\ t),\ k = 1, \dots,N,
    $$
что можно также представить в виде
\begin{equation} \label{ch4-2}
    X = \begin{bmatrix}
        A\\
        A^2\\
        \vdots\\
        A^N
    \end{bmatrix} x(t) + \begin{bmatrix}
        B & 0 & \vdots & 0 \\
        AB & B & \vdots & 0 \\
        \cdots & \cdots & \vdots & \cdots &\\
        A^{N-1}B & A^{N-1}B & \vdots & B \\

    \end{bmatrix}U.
\end{equation}

Вводя обозначения
$$
\Omega = \begin{bmatrix}
A\\
A^2\\
\vdots\\
A^N
\end{bmatrix}, \
\Gamma = \begin{bmatrix}
    B & 0 & \vdots & 0 \\
    AB & B & \vdots & 0 \\
    \cdots & \cdots & \vdots & \cdots &\\
    A^{N-1}B & A^{N-1}B & \vdots & B
\end{bmatrix},
$$
можем записать
$$
    X = \Omega x(t) + \Gamma U.
$$

С помощью (\ref{ch4-2}) переписываем (\ref{yav-4}):

$$
    J(x(t), u) = \frac{1}{2} x^T(t)Yx(t) + \frac{1}{2} U^THU + x^T(t)FU_x,
$$
где
$$
    Y = 2(Q + \Omega^T \tilde{Q}\Omega)
$$
$$
    H = 2(\tilde{R} + \Gamma^T\tilde{Q}\Gamma)
$$
$$
    F = 2\Omega^T\tilde{Q}\Gamma
$$
$$
    \begin{bmatrix}
        C_x & \ & \ \\
        \ & \ddots & \ \\
        \ & \ & C_x
    \end{bmatrix} (\Omega x(t) + \Gamma U) \le \begin{bmatrix}
        d_x \\
        \vdots \\
        d_x
    \end{bmatrix}
$$

Аналогично для $u$ и $x(t + N)$
$$
    GU \le W+ Ex(t),
    $$
где $G = diag(C_x,\dots, C_x),\ W = [d_x,\dots,d_x]^T,\ E = diag(C_x,\dots,C_x)\Omega$.

Задача (\ref{yav-1}) будет иметь следующий вид:
\begin{equation} \label{yav-mpc-min}
    \min_{U} \frac{1}{2} u^THU + x^TFU = \frac{1}{2}x^TYx,
\end{equation}
при условии
$$GU \le W + Ex.$$
Сделаем замену переменных:
$$z := U + H^{-1}F^Tx,$$
где $H^{-1}$ --- положительно определенная матрица.

Тогда задача (\ref{yav-mpc-min}) примет вид
\begin{equation} \label{yav-5}
 J(x) = \min_z \frac{1}{2}z^THz + \frac{1}{2}x^T\tilde{Y}x,
\end{equation}
при условиях
$$Gz \le W + sx,$$
где $\tilde{Y} = Y - FH^{-1}F^T, \ S := E + GH^{-1}F^T$.

Задача (\ref{yav-5}) строго выпуклая с допустимым множеством с непустой внутренней частью, поэтому для нее выполняются условия регулярности Слейтера. Существует единственное оптимальное решение и оно характеризуется условиями Каруша-Куна-Такера.

Явный MPC использует методы параметрического программирования для задачи (\ref{yav-5}) с параметром $x$.

Известно, что множество допустимых значений параметра X (выбирается простое многогранное множество) в задаче (\ref{yav-5}) разбивается на непересекающиеся многогранники $X_i,\ i \in I$ ($I$ --- множество индексов), в каждом из которых определено решение $z(x)$, как линейная функция $x$. Последнее, в свою очередь влечет линейность закона управления $u(x) = K_ix,\ x\in X_i,\ i \in I$.

Таким образом задача (\ref{yav-5}) решается для всех состояний (значений параметра $x$), что дает явную функцию управления, как функцию состояния, т.е. обратную связь $u(x),\ x \in X$.
% \begin{equation*} \label{ch4-a}
%     Hz + G^T \lambda = 0
% \end{equation*}
% \begin{equation*} \label{ch4-b}
% \lambda_{i}(G_iz - w_i - s_ix) = 0, \ i = \overline{1, q}
% \end{equation*}
% \begin{equation} \label{ch4-c}
% \lambda_{i} \ge 0
% \end{equation}
% \begin{equation} \label{ch4-d}
% Gz \le w + sx
% \end{equation}
% $$
%     z^{*}(x) = \dots
% $$

% $
%     A(x) = {i = {1, \dots, q}, G_iz^0(x) = w_i + s_ix}
% $
% --- оптимальное активное множество \\
% $G^A, W^A, S^A$ --- сроки содержащие элементы активного множества \\

% \begin{equation} \label{ch4-5}
%     z^{*}(x) = -W^{-1}G^T\lambda = -W^{-1}(G^A)^T\lambda^A
% \end{equation}

% Для всех активных компонент выполняется равенство:
% \begin{equation} \label{ch4-6}
%     \begin{aligned}
%         & G^Az^{*} (x) = w(A) + s^Ax, \\
%         & -G^AH^{-1}(G^A)^T\lambda^A = w^A + s^Ax, \\
%         & \lambda^A = -(G^AH^{-1}(G^A)^T)^{-1}(W^A+s^Ax).
%     \end{aligned}
% \end{equation}

% \begin{equation}\label{ch4-7}
%     \text{\ref{ch4-5}, \ref{ch4-6}}
%     \Rightarrow z^{*}(x) = H^{-1}(G^A)^T(G^AW^{-1}(G^A)^T)(W^A+s^Ax)
% \end{equation}
% \ref{ch4-7} $\Rightarrow$ \ref{ch4-d}
% \begin{equation}\label{ch4-8}
%     GH^{-1}(G^A)^T(G^AH^{-1}(G^A)^T)^{-1}(W^A + s^Ax) \le w + sx
% \end{equation}
% \ref{ch4-8} $\Rightarrow$ \ref{ch4-c}
% \begin{equation}\label{ch4-9}
%     -(G^AH^{-1}(G^A)^T)^{-1}(W^A + s^Ax) \ge 0
% \end{equation}

Алгоритм:
\begin{enumerate}
    \item Выбрать $x_0 \in X$ (например $x_0 = 0$)
    \item Решить задачу при $x = x_0 \Rightarrow z^{*}(x_0)$ \label{ch4-item}
    \item Определить активные ограничения $\Rightarrow G^A, W^A, s^A$
    \item Вычислить критическую область $X_i$ по активным ограничениям и вычислить функцию управления для этой области
    \item Перейти через границу $CR^A$, взять новое $x_0$ и $\rightarrow$ \ref{ch4-item}
\end{enumerate}

\begin{theorem}\label{ch4-th1}
    Пусть имеется линейная система, линейные ограничения, функция стоимости квадратичная. Тогда полученный регулятор $u_{MPC}(x)$ является непрерывным и кусочно-линейным.
    Функция, предствляющая собой оптимальную стоимость $J^{*}(x)$ также является непрерывной выпуклой и кусочно-квадратичной.
\end{theorem}

\section{Синтез оптимальной системы}

В данном разделе рассмотрим задачу оптимального управления линейной системой со скалярным управлением
$$
    \dot{x} = Ax + bu,
$$
cо следующим критерием качества
\begin{equation*}
    J(u) = \int_0^{t_f}|u(t)|dt \to \min,
\end{equation*}
при условиях
$$
    x(0) = x_0,\ x(t_f) = 0, \ \ |u(t)|\le L,
$$
где $L>0$ --- амплитуда управления.

Семейство, в которое погружается задача для определения обратной связи, имеет вид
\begin{equation}\label{3-2-1}
    J(u) = \int_{\tau}^{t_f}|u(t)|dt \to \min,
\end{equation}
$$
    \dot{x} = Ax + bu, \ x(\tau) = z,
$$
$$
    x(t_f) = 0, \ \ |u(t)|\le L, t\in [\tau, t_f].
$$
Здесь $z$ выступает в качестве параметра.


Чтобы избавиться от модуля в подынтегральном выражении представим $u(t)$  в виде:
$$
    u(t) = u_1(t) - u_2(t),
$$
тогда $|u(t)| = u_1(t) + u_2(t)$, где $0 \le u_1(t) \le 1, \ 0 \le u_2(t) \le 1.$

Таким образом, в классе дискретных оптимальных управлений получаем криерий качества:
$$
    \int_{\tau}^{t_f}u_1(t) + u_2(t)dt = \sum_{s \in T_h(\tau)}h(u_1(s) + u_2(s)) \to \min.
$$

Тогда в результате проделанных преобразований привели задачу (\ref{3-2-1}) к следующему виду:
\begin{equation*} \label{3-2-2}
    \begin{aligned}
        & \sum_{s \in T_h(\tau)}h(u_1(s) + u_2(s)) \to \min,\\
        & \dot{x} = Ax + bu_1 - bu_2,   \\
        &  x(\tau) = z, \ \ x(t_f) = 0, \\
        & 0\le u_1(s)\le L, \ 0\le u_1(s)\le L, \  s\in T_h(\tau).
    \end{aligned}
\end{equation*}

Далее, задачу в классе дискретных управляющих воздействий можно свести к дискретной задаче оптимального управления. Для этого по формуле Коши запишем соотношение:
\begin{equation*}
    \begin{aligned}
        & x(s+h) = F(s+h, s)x(s) + \int_s^{s+h}F(s+h, \theta)b(\theta)(u_1(\theta) - u_2(\theta))d \theta =\\ & F(s + h, s)x(s) + \int_s^{s+h}F(s+h, \theta)b(\theta)d \theta (u_1(s) - u_2(s)).
    \end{aligned}
\end{equation*}
Введем обозначения:
$$
    A_h(s) = F(s + h, s),
$$
$$
    B_h(s) = \int_{s}^{s+h}F(s+h, \theta)b(\theta)d\theta.
$$

В результате $x(s + h)$ будет представлен в следующем виде:
$$
    x(s +h) = A_h(s)x(s) + B_h(s) (u_1(s) - u_2(s)),\ s = \overline{k, tf-h}.
$$

Таким образом,  получаем, что исходная задача (\ref{3-2-1}) эквивалентна следующей задаче оптимального управления дискретной системой:
\begin{equation} \label{3-2-3}
    \begin{aligned}
        & \sum_{s \in T_h(\tau)} h(u_1(s) + u_2(s)) \to \min,\\
        &  x(s +h) = A_h(s)x(s) + B_h(s) (u_1(s) - u_2(s)),\ s = \overline{k, tf-h},\\
        & x(\tau) = z, \ x(t_f) = 0,\\
        & 0 \le u_1(s) \le 1, \ 0 \le u_2(s) \le 1,\ s = \overline{k, tf-h}.
    \end{aligned}
\end{equation}

% Вектор неизвестных: $(x, u1, u2)$

Примем $\tau = kh$ и распишем получившиеся матрицы в блочном виде:
$$
    C = \begin{bmatrix}
        0\\
        \cdots\\
        0\\
        -h\\
        \cdots\\
        -h
    \end{bmatrix}\\
    d_{*} = \begin{bmatrix}
        -\infty\\
        \cdots\\
        -\infty\\
        0\\
        \cdots\\
        0
    \end{bmatrix}
    d^{*} = \begin{bmatrix}
        +\infty\\
        \cdots\\
        +\infty\\
        1\\
        \cdots\\
        1
    \end{bmatrix},
$$
где размерности векторов $x$ --- $(N+1-k)n$ и $u$  --- $2r(N - k)$.

Матрицы $b$ и $A$ имеют следующий вид:
$$
    b = \begin{bmatrix}
        z\\
        0\\
        \cdots\\
        0
    \end{bmatrix},
$$
$$
    A = \begin{bmatrix}
        E_{n \times n} & 0_{n \times n} & \cdots & 0_{n \times n} & 0_{n \times r} \cdots 0_{n \times r} & 0_{n \times r} \cdots 0_{n \times r}\\
        0_{n \times n} & 0_{n \times n} & \cdots & E_{n \times n} & 0_{n \times r} \cdots 0_{n \times r} & 0_{n \times r} \cdots 0_{n \times r}\\
        -A_h(\tau) & E_{n \times n} & \cdots & 0_{n \times n} & -B_h(\tau) \cdots 0_{n \times r} & B_h(\tau) \cdots 0_{n \times r}\\
        \cdots\\
        0_{n \times n} & 0_{n \times n} & .. -A_h(t_f - h) & E_{n \times n} & .. -B_h(t_f-h) & .. B_h(t_f-h)
    \end{bmatrix},
$$
где $n(2 + N - k)$ --- количество строк, $(N + 1 - k)n + 2r(N -k)$ --- количество столбцов.

Задача (\ref{3-2-3}) является также и задачей линейного программирования, переменными оптимизации являются $x$ и $u$, параметром --- $z\in \mathbb{R}^n$.

Число переменных оптимизации в задаче линейного программирования можно сократить, выразив траекторию через управление. Получаемая задача носит название функциональной формы.

Запишем по формуле Коши терминальное состояние:
\begin{equation*}
    x(t_f) = F(t_f, t_0)x_0 + \int_{t_0}^{t_f}F(t_f, \theta)b(u_1(\theta) - u_2(\theta))d\theta.
\end{equation*}
В силу дискретности управляющего воздействия, интеграл на промежутке $T = [t_0, t_f]$ представим в виде суммы интегралов на промежутках $[s,s+h],\ s \in T_h$:
\begin{equation*}
    \begin{aligned}
        & x(t_f) = F(t_f, t_0)x_0 + \sum_{s=t_0}^{t_f-h} \int_{s}^{s+h}F(t_f, \theta)b(u_1(\theta) - u_2(\theta))d\theta \\
        & = F(t_f, t_0)x_0 + \sum_{s \in T_h}\int_{s}^{s+h}F(t_f, \theta)b d\theta (u_1(s) - u_2(s)).
    \end{aligned}
\end{equation*}

Теперь представим терминальные ограничения в виде:
\begin{equation*}
   x(t_f) = F(t_f, t_0)x_0 +  \sum_{s \in T_h}\int_{s}^{s+h} F(t_f, \theta)b \ d\theta (u_1(s) - u_2(s)) = 0.
\end{equation*}

Введем обозначение:
\begin{equation*}
    d_h(s) = \int_{s}^{s+h} F(t_f, \theta)b \ d\theta,
\end{equation*}
\begin{equation*}
    G(t_0) = - F(t_f, t_0), \ \ 
    G(\tau) = - F(t_f, \tau).
\end{equation*}

Исходная задача в классе дискретных управляющих воздействий будет иметь вид:
\begin{equation*}
    \begin{aligned}
        & \sum_{s \in T_h} h(u_1(s) + u_2(s)) \to \min,\\
        & \sum_{s \in T_h} d_h(s)(u_1(s) - u_2(s)) = G(t_0)x_0, \\
        & 0 \le u_i(s) \le L, \ i = 1, 2, \ \ s \in T_h,\\
    \end{aligned}
\end{equation*}
а задача для позиции $(\tau,z)$:
\begin{equation*}
    \begin{aligned}
        & \sum_{s \in T_h(\tau)} h(u_1(s) + u_2(s)) \to \min,\\
        & \sum_{s \in T_h(\tau)} d_h(s)(u_1(s) - u_2(s)) = G(\tau)z, \\
        & 0 \le u_i(s) \le L, \ i = 1, 2, \ s \in T_h(\tau).\\
    \end{aligned}
\end{equation*}
Полученные задачи  --- функциональная форма задачи оптимального управления, при этом параметр был вынесен справа явно.

Соответствующая задача, как задача mp-LP:
\begin{equation*}
    \begin{aligned}
        & {\bf 1}^T U \to \min,\\
        & DU = G(\tau)z, \\
        & 0 \le U \le L{\bf 1},\\
    \end{aligned}
\end{equation*}
где 
$$  
    D = [d_h(\tau)\ -d_h(\tau)\ \ldots \ d_h(t_f-h)\ -d_h(t_f-h)],
     $$
$$ 
    U = [u_1(\tau)\ u_2(\tau)\ \ldots \ u_1(t_f-h)\ u_2(t_f-h)]^T,
     $$
${\bf 1}$ --- вектор из единиц соответствующей размерности.
