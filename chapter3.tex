\chapter{Применение параметрического программирования в задачах синтеза и MPC}\label{chap2}

Мы изучаем задачи оптимального управления и построение оптимальной обратной связи. В нашем подходе будет использоваться многопараметрическое программирование, и нашей главной целью будет получение решения с обратной связью по состоянию, а также получение алгоритмов для его эффективного вычисления.

В нашем фреймворке параметрическое программирование является основным методом, используемым для изучения и вычисления законов оптимального управления с обратной связью. Фактически, мы формулируем конечные задачи оптимального управления в виде математических программ, в которых входная последовательность является вектором оптимизации.
В зависимости от динамической модели системы, характера ограничений и используемой функции, получается другая математическая программа.
Текущее состояние динамической системы входит в функцию стоимости и ограничения в качестве параметра, который влияет на решение математической программы.
Мы изучаем структуру решения при изменении этого параметра и описываем алгоритмы решения многопараметрических линейных, квадратичных и смешанных целочисленных программ.
Они представляют собой основные инструменты для вычисления законов оптимального управления с обратной связью.

Мы показываем, что решение всех этих задач оптимального управления может быть выражено в виде кусочно-афинного закона обратной связи. \\
Кроме того, закон оптимального управления непрерывен, а функция значений выпукла и непрерывна.

Оптимальное управление ограниченными линейно-кусочно-аффинными (PWA) системами получило отличное
интерес к исследовательскому сообществу из-за легкости постановки сложных проблем
и их решения. 

\section{Явный MPC}
Явный МРС — очень популярный подход, который реализует идею, в которой вычисления переносятся со второго шага базового алгоритма MPC на подготовительный (еще до начала вычислений). Явные схемы на текущий момент времени могут быть использованы только для линейных динамических систем и линейных или квадратичных критериев качества.

В основе явных схем лежат следующие наблюдения: линейные или линейно-квадратичные задачи оптимального управления при численном решении сводятся к задачам линейного или квадратичного программирования, которые зависят от состояния $x = x(t)$, которое, в свою очередь, принимается как параметр. В итоге получаем задачу параметрического программирования, для которой к настоящему моменту были развиты специальные методы решения. Они позволяют нам получить явный закон управления $u(x)$.

Развитие подхода на нелинейные системы является не тривиальным, однако и в линейных случаях есть проблемы, касающиеся эффективности вычислений даже для задач средней размерности.

Ниже продемонстрируем основную идею явного MPC.

Решается задача следующего вида:
% $$
%     \begin{aligned}
%         & x^{+} = Ax + Bu, \\
%         & C_{x}x \le dx, \\
%         &  C_{u}u \le du \\
%      \end{aligned}
% $$
\begin{equation} \label{yav-1}
    J(x) = \min_{u(\cdot | t)} \sum_{t}^{t+N-1} L(x(k(t), u(k(t))) + F(x(t+N)t)),
\end{equation}

При условиях
$$
x(k+1 |\ t) = Ax(k\ |\ t) + Bu(k\ |\ t), \\
$$
$$
x(t\ |\ t) = x(t), \\
$$
$$
C_{x}x(k\ |\ t) \le dx, \ t \le k \le t+N-1, \\
$$
$$
C_{u}u(k\ |\ t) \le du, \ C_{x}x(t+N\ |\ t) = d_f, \\
$$
$$
C_f x(t + N |\ t) \le d^f, \\
$$

со следующей квадратичной функцией стоимости конкретного этапа и терминальной стоимостью:
$$ 
\begin{aligned}
        & L(x, u) = x^TQx + u^TRu, \\
        & F(x) = x^TQx + u^TRu,\ Q,R > 0, \\
\end{aligned}
$$
где $C_x, C_u, C_f, d_x, d_u, d^f$ —  ограничения на траекторию, управления и терминальное состояние.

Перепишем \ref{yav-1} в виде задачи квадратичного программирования:
\begin{equation*} \label{yav-2}
    X := [x^T(t + 1 |\ t),\ \dots,\ x^T(t + N|\ t)]^T,
\end{equation*}

\begin{equation*} \label{yav-3}
    U := [u^T(t + 1 |\ t),\ \dots,\ u^T(t + N|\ t)]^T,
\end{equation*}

\begin{equation} \label{yav-4}
    J(x(t),\ U) = x^T(t)Qx(t)+X^T\tilde{Q}X + U^T\tilde{R}U,
\end{equation}

Далее выражаем состояние системы в момент $t + k$ через $x(t)$ и $u$:
$$x(t+k \ |\ t) = A^kx(t) + \sum_{j=0}^{k-1}A^jBu(t+k-j-1 \ |\ t),\ k = 1, \dots,N$$
\begin{equation} \label{ch4-2}
    X = \begin{bmatrix}
        A\\
        A^2\\
        \vdots\\
        A^N
    \end{bmatrix} x(t) + \begin{bmatrix}
        B & 0 & \vdots & 0 \\
        AB & B & \vdots & 0 \\
        \cdots & \cdots & \vdots & \cdots &\\
        A^{N-1}B & A^{N-1}B & \vdots & B \\
        
    \end{bmatrix}U,
\end{equation}

$$
\begin{bmatrix}
A\\
A^2\\
\vdots\\
A^N
\end{bmatrix} \Rightarrow \Omega, \ \begin{bmatrix}
    B & 0 & \vdots & 0 \\
    AB & B & \vdots & 0 \\
    \cdots & \cdots & \vdots & \cdots &\\
    A^{N-1}B & A^{N-1}B & \vdots & B \\
    
\end{bmatrix} \Rightarrow \Gamma
$$

$$
    X = \Omega x(t) + \Gamma U
$$

С помощью (\ref{ch4-2}) переписываем (\ref{yav-4}):

$$
    J(x(t), u) = \frac{1}{2} x^T(t)Yx(t) + \frac{1}{2} U^THU + x^T(t)FU_x,
$$
где
$$
    Y = 2(Q + \Omega^T \tilde{Q}\Omega)
$$
$$
    H = 2(\tilde{R} + \Gamma^T\tilde{Q}\Gamma)
$$
$$
    F = 2\Omega^T\tilde{Q}\Gamma
$$
$$
    \begin{bmatrix}
        C_x & \ & \ \\
        \ & \ddots & \ \\
        \ & \ & C_x
    \end{bmatrix} (\Omega x(t) + \Gamma u) \le \begin{bmatrix}
        dx \\
        \vdots \\
        dx
    \end{bmatrix}^T
$$\\
Аналагично для $u$ и $x(t + N)$

$$GU \le W+ Ex(t)$$
Задача (\ref{yav-1}) примет вид
$$\min_{u} \frac{1}{2} u^THU + x^TFU = \frac{1}{2}x^TYx,$$
при условии
$$GU \le W + Ex.$$
Сделаем замену переменных:
$$z := U + H^{-1}F^Tx,$$
где $H^{-1}$ --- положительно определенная матрица.
$$\overline{Y} = Y - FH^{-1}F^T,$$
\begin{equation} \label{yav-5}
    \Rightarrow \min_z \frac{1}{2}z^THz + \frac{1}{2}x^T\tilde{Y}x,
\end{equation}
при условиях
$$Gz \le w + sx, \ S = E + GH^{-1}А,Е$$

Задача (\ref{yav-5}) строго выпуклая с допустимым множеством с непустойвнутренней частью, поэтому для нее выполняются условия регулярности Слейтера. Существует единственное оптимальное решение и оно характеризуется условиями Каруша-Куна-Такера.

Явный MPC использует методы параметрического программирования для задачи (\ref{yav-5}) с параметром $x$.
\begin{equation*} \label{ch4-a}
    Hz + G^T \lambda = 0
\end{equation*}
\begin{equation*} \label{ch4-b}
\lambda_{i}(G_iz - w_i - s_ix) = 0, \ i = \overline{1, q}
\end{equation*}
\begin{equation} \label{ch4-c}
\lambda_{i} \ge 0
\end{equation}
\begin{equation} \label{ch4-d}
Gz \le w + sx
\end{equation}
$$
    z^{*}(x) = \dots
$$

$
    A(x) = {i = {1, \dots, q}, G_iz^0(x) = w_i + s_ix}
$
--- оптимальное активное множество \\
$G^A, W^A, S^A$ --- сроки содержащие элементы активного множества \\

\begin{equation} \label{ch4-5}
    z^{*}(x) = -W^{-1}G^T\lambda = -W^{-1}(G^A)^T\lambda^A
\end{equation}

Для всех активных компонент выполняется равенство:
\begin{equation} \label{ch4-6}
    \begin{aligned}
        & G^Az^{*} (x) = w(A) + s^Ax, \\
        & -G^AH^{-1}(G^A)^T\lambda^A = w^A + s^Ax, \\
        & \lambda^A = -(G^AH^{-1}(G^A)^T)^{-1}(W^A+s^Ax).
    \end{aligned}
\end{equation}

\begin{equation}\label{ch4-7}
    \text{\ref{ch4-5}, \ref{ch4-6}}
    \Rightarrow z^{*}(x) = H^{-1}(G^A)^T(G^AW^{-1}(G^A)^T)(W^A+s^Ax)
\end{equation}
\ref{ch4-7} $\Rightarrow$ \ref{ch4-d}
\begin{equation}\label{ch4-8}
    GH^{-1}(G^A)^T(G^AH^{-1}(G^A)^T)^{-1}(W^A + s^Ax) \le w + sx
\end{equation}
\ref{ch4-8} $\Rightarrow$ \ref{ch4-c}
\begin{equation}\label{ch4-9}
    -(G^AH^{-1}(G^A)^T)^{-1}(W^A + s^Ax) \ge 0
\end{equation}

Алгоритм: 
\begin{enumerate}
    \item $x_0 \in X$ (например $x_0 = 0$)
    \item Решить задачу при $x = x_0 \Rightarrow z^{*}(x_0)$ \label{ch4-item}
    \item Определить активные ограничения $\Rightarrow G^A, W^A, s^A$
    \item Найти из \ref{ch4-8}, \ref{ch4-9} $CR^A$ --- критическая область 
    \item Перейти через границу $CR^A$, взять новое $x_0$ и $\rightarrow$ \ref{ch4-item}
\end{enumerate}

\begin{theorem}\label{ch4-th1}
    Пусть у нас имеется линейная система, линейные ограничения, функция стоимости квадратичная. Тогда полученный регулятор $u_{MPC}(x)$ является непрерывным и кусочно-линейным.
    Функция, предствляющая собой оптимальную стоимость $J^{*}(x)$ также является непрерывной выпуклой и кусочно-квадратичной
\end{theorem}

\section{Синтез оптимальной системы}
% \section{Динамическое программирование}
% Постановка задачи: пусть имеется некоторый объект, изменяющий свое состояние в дискретные моменты времени.
% В каждый момент времени $t = \overline{0,\ N}$ поведение объекта полностью описывается $n$-вектором \\$x(t) = (x_{1}(t),\ \dots,\ x_n(t))$\\
% Динамика объекта описывается следующим рекурентным уравнением: \\$x(t+1) = f(x(t),\ u(t),\ t),\ x(0) = x_0,\ t = \overline{0,\ N-1}$\\
% $u(t) = (u_1(t), \ \dots,\ u_r(t))$ --- управляющее воздействие в момент времени $t$, $u(t) \in U(t) \in \mathbb{R}^r$, $f(\cdot)$ --- вектор функция определенная в области значений своих аргументов, $x_0$ --- начальное состояние объекта управления.\\
% При заданном состоянии $x_0$ поведение объекта полнсотью определяется управляющим воздействием $u(t)$. Качество управления оценим следующим критерием качества (типа Больца)
% \begin{equation}\label{ch4-dimanic-1}
%     \begin{cases}
%         J(u) = \phi(x(N)) + \sum_{t = 0}^{N-1}f_0(x(t),u(t),t) \to \min \\
%         \phi(x),\ f_0(x,\ u,\ t) \text{\ --- функция определенная в области значений своих аргументов}\\
%         x(t+1) = f(x(t),\ u(t),\ t),\ x(0) = x_0, \ t = \overline{0, N-1},\ u(t) \in U(t)
%     \end{cases}
% \end{equation}
% 3 этапа:
% \begin{enumerate}
%     \item Инвариантное погружение, построение функции Беллмана. Исходная задача погружается в некое семейство зависящее от параметров
%     \item Составление управления Беллмана
%     \item Решение уравнения Беллмана и всей задачи в целом
% \end{enumerate}
% Любая задача характеризуется набором своих параметров, таких как число переменных, момента начала и конца процесса. При инвариантном погружении отвлекаются от заданного значения некоторых параметров и считают их переменными велечинами.\\
% Для нашей задачи \ref{ch4-dimanic-1} в качестве таких параметров выберем:
% \begin{enumerate}
%     \item Момент начала управления вместо $t = 0$ возьмем $\tau = \overline{0,N-1}$
%     \item Начальное состояние процесса вместо $x_0$ состояние $z \in \mathbb{R}^n$ в момент времени $\tau$
% \end{enumerate}
% Таким образом семейство, в которое погружается задача \ref{ch4-dimanic-1} будет иметь следующий вид:
% \begin{equation} \label{ch4-sem}
%     \begin{cases}
%         J(u(\tau,z)) = \phi(x(N)) + \sum_{t = \tau}^{N-1} f_0(x(t),\ u(t),\ t) \to \min \\
%         x(t+1) =  f(x(t), u(t), t),\ x(\tau) = z \\
%         u(t) \in U(t), \ t = \overline{\tau, N-1}
%     \end{cases}
% \end{equation}
% \ref{ch4-dimanic-1}, $\tau = 0,\ z=x_0$ --- исходня задача.\\
% Пара $(\tau,z)$ --- позиция многошагового процесса. Минимальное значение критерия качества в задачах \ref{ch4-sem}, как функция позиции $(\tau, z)$\\
% $$B(\tau, z) = \min_u J(u(\tau,\ z)) \text{\ --- функция Беллмана}$$

% \subsection{Динамическое программирование для задачи ОУ в классе кусочно-непрерывных управлений}
% \begin{equation}\label{dyn-1}
%     \begin{cases}
%         J(u) = \phi(x(t_f)) + \int_{t_0}^{t_f}f_0(x(t),u(t),t)dt \to \min \\
%         \dot{x} = f(x,\ u,\ t),\ x(t_0) = x_0 \\
%         u(t) \in U, \ t \in T = [t_0, \ t_f]
%     \end{cases}
% \end{equation}
% $u(t)$ --- кусочно-непрерывная функция\\
% Погрузим задачу \ref{dyn-1} в следующее семейство задач:
% \begin{equation}\label{dyn-2}
%     \begin{cases}
%         J(u(\tau,\ z)) = \phi(x(t_f)) + \int_{\tau}^{t_f}f_0(x(t),u(t),t)dt \to \min \\
%         \dot{x} = f(x,u,t), \ x(\tau) = z \\
%         u(t) \in U,\ t \in T(\tau) = [\tau, t_f]
%     \end{cases}
% \end{equation}
% --- зависящее от $\tau \in T$ и $z \in \mathbb{R}^n$ \\
% $B(\tau,\ z) = \min_u J(u\ |\ \tau,\ z ),\ \tau \in T, \ z \in \mathbb{R}^n$ --- функция Беллмана
% После вывода уравнения Белламана получим решение уравнения: 
% $$
%     \frac{\partial B(\tau,\ z)}{\partial z} f(z,\ u^0(\tau,\ z)) + f_0(z,\ u^0(\tau,\ z),\ z) = \min_{v \in U}(\frac{\partial B(\tau,\ z)^{'}}{\partial z} f(z,\ v,\ \tau) + f_0(z,\ v,\ \tau)), \ \forall \tau \in T,\ z \in \mathbb{R}^n
% $$

% \section{Сведение задачи для позиции (tau, z) к задаче многопараметрического линейного программирования}
В данном разделе произведем сведение задачи для позиции (tau, z) к задаче многопараметрического линейного программирования.
Рассмотрим задачу оптимального управления системой:
$$
    \dot{x} = Ax + Bu
$$
cо следующим критерием качества
\begin{equation} \label{3-2-1}
    J(u) = \int_0^{t_f}|u(t)|dt \to min
\end{equation}
при условиях
$$
    x(0) = x_0,\ x(t_f) = 0.
$$

Произведем замену
$$
    x(\tau) = z.
$$
Чтобы избавиться от модуля в подинтегральном выражениии представим $u(t)$  в виде:
$$
    u(t) = u_1(t) - u_2(t),
$$
тогда $|u(t)| = u_1(t) + u_2(t)$, где $0 \le u_1(t) \le 1, \ 0 \le u_2(t) \le 1.$

Таким образом получаем:
$$
    \int_{\tau}^{t_f}u_1(t) + u_2(t)dt = \sum_{s = \overline{k, t_f - h}}h(u_1(s) + u_2(s) \to \min
$$
В результате преобразования мы привели задачу (\ref{3-2-1}) к следующему виду:
\begin{equation*} \label{3-2-2}
    \begin{aligned}
        & \sum_{s = \overline{k, t_f - h}}h(u_1(s) + u_2(s) \to \min,\\
        & \dot{x} = Ax + Bu_1 - Bu_2.
    \end{aligned}
\end{equation*}

Задачу в классе дискретных управляющих воздействий можно свести к дискретной задаче оптимального управления. Для этого по формуле Коши запишем соотношение:
\begin{equation*}
    \begin{aligned}
        & x(s+h) = F(s+h, s)x(s) + \int_s^{s+h}F(s+h, \theta)b(\theta)u(\theta)d \theta =\\ & F(s + h, s)x(s) + \int_s^{s+h}F(s+h, \theta)b(\theta)d \theta u(s)
    \end{aligned}
\end{equation*}
Введем обозначения
$$
    A_h = F(s + h, s)
$$
$$
    b_h = \int_{s}^{s+h}F(s+h, \theta)b(\theta)d\theta
$$
$$\Downarrow$$
$$
    x(s +h) = A_h(s)x(s) + b_h(s)u(s),\ s = \overline{k, tf-h}
$$

Таким образом мы получаем, что исходня задача (\ref{3-2-1}) эквивалентна следующей задаче оптимального управления дискретной системы:
\begin{equation*} \label{3-2-3}
    \begin{aligned}
        & \sum_{s = \overline{k, t_f - h}}h(u_1(s) + u_2(s) \to \min,\\
        &  x(s +h) = A_h(s)x(s) + b_h(s)u(s),\ s = \overline{k, tf-h},\\
        & x(\tau) = z, \ x(t_f) = 0,\\
        & 0 \le u_1(s) \le 1, \ 0 \le u_2(s) \le 1,\ s = \overline{k, tf-h}
    \end{aligned}
\end{equation*}

Вектор неизвестных: $(x, u1, u2)$

Примем $\tau = kh$ и распишем получившиеся матрицы в блочном виде:
$$
    C = \begin{bmatrix}
        0\\
        \cdots\\
        0\\
        -h\\
        \cdots\\
        -h
    \end{bmatrix}\\
    d_{*} = \begin{bmatrix}
        -\infty\\
        \cdots\\
        -\infty\\
        0\\
        \cdots\\
        0
    \end{bmatrix}
    d^{*} = \begin{bmatrix}
        +\infty\\
        \cdots\\
        +\infty\\
        1\\
        \cdots\\
        1
    \end{bmatrix},
$$
где размерности векторов $x = (N+1-k)n$ и $u = 2r(N - k)$.

Матрицы $b$ и $A$ имеют следующий вид:
$$
    b = \begin{bmatrix}
        z\\
        0\\
        \cdots\\
        0
    \end{bmatrix}
$$
$$
    A = \begin{bmatrix}
        E_{n \times n} & 0_{n \times n} & \cdots & 0_{n \times n} & 0_{n \times r} \cdots 0_{n \times r} & 0_{n \times r} \cdots 0_{n \times r}\\
        0_{n \times n} & 0_{n \times n} & \cdots & E_{n \times n} & 0_{n \times r} \cdots 0_{n \times r} & 0_{n \times r} \cdots 0_{n \times r}\\
        -A_h(\tau) & E_{n \times n} & \cdots & 0_{n \times n} & -B_h(\tau) \cdots 0_{n \times r} & B_h(\tau) \cdots 0_{n \times r}\\
        \cdots\\
        0_{n \times n} & 0_{n \times n} & .. -A_h(t_f - h) & E_{n \times n} & .. -B_h(t_f-h) & .. B_h(t_f-h)
    \end{bmatrix}
$$
где $n(2 + N - k)$ --- количество строк, $(N + 1 - k)n + 2r(N -k)$ --- количество столбцов